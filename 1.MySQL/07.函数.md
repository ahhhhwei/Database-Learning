# 07.函数

## 一、时间函数

![image-20230430140449945](C:\Users\20848\AppData\Roaming\Typora\typora-user-images\image-20230430140449945.png)

- 获得日期：

  ```sql
  mysql> select current_date();
  +----------------+
  | current_date() |
  +----------------+
  | 2023-04-30     |
  +----------------+
  1 row in set (0.00 sec)
  ```

- 获得时间

  ```sql
  mysql> select current_time();
  +----------------+
  | current_time() |
  +----------------+
  | 14:06:39       |
  +----------------+
  1 row in set (0.00 sec)
  ```

- 获得时间戳

  ```sql
  mysql> select current_timestamp();
  +---------------------+
  | current_timestamp() |
  +---------------------+
  | 2023-04-30 14:07:11 |
  +---------------------+
  1 row in set (0.00 sec)
  ```

- 案例

  - 创建一个留言表

    ```sql
    mysql> create table msg (
        -> id int primary key auto_increment,
        -> content varchar(30) not null,
        -> sendtime datetime
        -> );
    Query OK, 0 rows affected (0.06 sec)
    ```

  - 插入数据

    ```sql
    mysql> insert into msg(content,sendtime) values('hello1', now());
    Query OK, 1 row affected (0.01 sec)
    
    mysql> insert into msg(content,sendtime) values('hello2', now());
    Query OK, 1 row affected (0.00 sec)
    
    mysql> select * from msg;
    +----+---------+---------------------+
    | id | content | sendtime            |
    +----+---------+---------------------+
    |  1 | hello1  | 2023-04-30 15:25:48 |
    |  2 | hello2  | 2023-04-30 15:26:00 |
    +----+---------+---------------------+
    2 rows in set (0.00 sec)
    ```

  - 显示所有留言信息，发布日期只显示日期，不用显示时间

    ```sql
    mysql> select content,date(sendtime) from msg;
    +---------+----------------+
    | content | date(sendtime) |
    +---------+----------------+
    | hello1  | 2023-04-30     |
    | hello2  | 2023-04-30     |
    +---------+----------------+
    2 rows in set (0.00 sec)
    ```

  - 请查询在2分钟内发布的帖子

    ```sql
    mysql> select * from msg where date_add(sendtime, interval 2 minute) > now();
    +----+---------+---------------------+
    | id | content | sendtime            |
    +----+---------+---------------------+
    |  1 | hello1  | 2023-04-30 15:25:48 |
    |  2 | hello2  | 2023-04-30 15:26:00 |
    +----+---------+---------------------+
    2 rows in set (0.00 sec)
    ```

## 二、字符函数

![image-20230430152806296](C:\Users\20848\AppData\Roaming\Typora\typora-user-images\image-20230430152806296.png)

- 获取`emp`表的`ename`列的字符集

  ```sql
  mysql> select charset(ename) from emp;
  +----------------+
  | charset(ename) |
  +----------------+
  | utf8mb3        |
  | utf8mb3        |
  | utf8mb3        |
  | utf8mb3        |
  | utf8mb3        |
  | utf8mb3        |
  | utf8mb3        |
  | utf8mb3        |
  | utf8mb3        |
  | utf8mb3        |
  | utf8mb3        |
  | utf8mb3        |
  | utf8mb3        |
  | utf8mb3        |
  +----------------+
  14 rows in set (0.00 sec)
  ```

- 以固定格式查询信息

  ```sql
  mysql> select concat (ename, '先生/女士，很荣幸地通知你，你的工作是：', job, ',你的月薪是：', sal, '$') as 通知 from emp;
  +-----------------------------------------------------------------------------------------------------+
  | 通知                                                                                                |
  +-----------------------------------------------------------------------------------------------------+
  | SMITH先生/女士，很荣幸地通知你，你的工作是：CLERK,你的月薪是：800.00$                               |
  | ALLEN先生/女士，很荣幸地通知你，你的工作是：SALESMAN,你的月薪是：1600.00$                           |
  | WARD先生/女士，很荣幸地通知你，你的工作是：SALESMAN,你的月薪是：1250.00$                            |
  | JONES先生/女士，很荣幸地通知你，你的工作是：MANAGER,你的月薪是：2975.00$                            |
  | MARTIN先生/女士，很荣幸地通知你，你的工作是：SALESMAN,你的月薪是：1250.00$                          |
  | BLAKE先生/女士，很荣幸地通知你，你的工作是：MANAGER,你的月薪是：2850.00$                            |
  | CLARK先生/女士，很荣幸地通知你，你的工作是：MANAGER,你的月薪是：2450.00$                            |
  | SCOTT先生/女士，很荣幸地通知你，你的工作是：ANALYST,你的月薪是：3000.00$                            |
  | KING先生/女士，很荣幸地通知你，你的工作是：PRESIDENT,你的月薪是：5000.00$                           |
  | TURNER先生/女士，很荣幸地通知你，你的工作是：SALESMAN,你的月薪是：1500.00$                          |
  | ADAMS先生/女士，很荣幸地通知你，你的工作是：CLERK,你的月薪是：1100.00$                              |
  | JAMES先生/女士，很荣幸地通知你，你的工作是：CLERK,你的月薪是：950.00$                               |
  | FORD先生/女士，很荣幸地通知你，你的工作是：ANALYST,你的月薪是：3000.00$                             |
  | MILLER先生/女士，很荣幸地通知你，你的工作是：CLERK,你的月薪是：1300.00$                             |
  +-----------------------------------------------------------------------------------------------------+
  14 rows in set (0.00 sec)
  ```

- 求员工表中员工姓名占用的字节数

  ```sql
  mysql> select ename, length(ename) from emp;
  +--------+---------------+
  | ename  | length(ename) |
  +--------+---------------+
  | SMITH  |             5 |
  | ALLEN  |             5 |
  | WARD   |             4 |
  | JONES  |             5 |
  | MARTIN |             6 |
  | BLAKE  |             5 |
  | CLARK  |             5 |
  | SCOTT  |             5 |
  | KING   |             4 |
  | TURNER |             6 |
  | ADAMS  |             5 |
  | JAMES  |             5 |
  | FORD   |             4 |
  | MILLER |             6 |
  +--------+---------------+
  14 rows in set (0.00 sec)
  ```

  > 注意：length函数返回字符串长度，以字节为单位。如果是多字节字符则计算多个字节数；如果是单字节字符则算作一个字节。比如：字母，数字算作一个字节，中文表示多个字节数（与字符集编码有关）

  ```sql
  mysql> select length('阿伟');
  +------------------+
  | length('阿伟')   |
  +------------------+
  |                6 |
  +------------------+
  1 row in set (0.00 sec)
  ```

- 截取`emp`表中`ename`字段的第二个到第三个**字符**

  `mysql`下标从1开始。

  汉字也是从用户视角来看的。

  ```sql
  mysql> select substring(ename, 2, 2), ename from emp;
  +------------------------+--------+
  | substring(ename, 2, 2) | ename  |
  +------------------------+--------+
  | MI                     | SMITH  |
  | LL                     | ALLEN  |
  | AR                     | WARD   |
  | ON                     | JONES  |
  | AR                     | MARTIN |
  | LA                     | BLAKE  |
  | LA                     | CLARK  |
  | CO                     | SCOTT  |
  | IN                     | KING   |
  | UR                     | TURNER |
  | DA                     | ADAMS  |
  | AM                     | JAMES  |
  | OR                     | FORD   |
  | IL                     | MILLER |
  +------------------------+--------+
  14 rows in set (0.00 sec)
  ```

  ```sql
  mysql> select substring('数据科学与大数据技术', 3, 2);
  +---------------------------------------------------+
  | substring('数据科学与大数据技术', 3, 2)           |
  +---------------------------------------------------+
  | 科学                                              |
  +---------------------------------------------------+
  1 row in set (0.00 sec)
  ```

- 将`emp`表中所有名字中有`S`的替换成`上海`

  ```sql
  mysql> select replace(ename, 'S', '上海') ,ename from emp;
  +-------------------------------+--------+
  | replace(ename, 'S', '上海')   | ename  |
  +-------------------------------+--------+
  | 上海MITH                      | SMITH  |
  | ALLEN                         | ALLEN  |
  | WARD                          | WARD   |
  | JONE上海                      | JONES  |
  | MARTIN                        | MARTIN |
  | BLAKE                         | BLAKE  |
  | CLARK                         | CLARK  |
  | 上海COTT                      | SCOTT  |
  | KING                          | KING   |
  | TURNER                        | TURNER |
  | ADAM上海                      | ADAMS  |
  | JAME上海                      | JAMES  |
  | FORD                          | FORD   |
  | MILLER                        | MILLER |
  +-------------------------------+--------+
  14 rows in set (0.00 sec)
  ```

- 这些函数也可以出现在`where`子句中，不一定非要在`select`后面。而聚合函数一般只在`select`后面。

## 三、数学函数

![image-20230430162214350](C:\Users\20848\AppData\Roaming\Typora\typora-user-images\image-20230430162214350.png)

- 绝对值

  ```sql
  mysql> select abs(-100.2);
  +-------------+
  | abs(-100.2) |
  +-------------+
  |       100.2 |
  +-------------+
  1 row in set (0.00 sec)
  ```

- 向上取整

  ```sql
  mysql> select ceiling(23.04);
  +----------------+
  | ceiling(23.04) |
  +----------------+
  |             24 |
  +----------------+
  1 row in set (0.00 sec)
  ```

- 向下取整

  ```sql
  mysql> select floor(23.7);
  +-------------+
  | floor(23.7) |
  +-------------+
  |          23 |
  +-------------+
  1 row in set (0.01 sec)
  ```

- 保留2位小数位数（小数四舍五入)

  ```sql
  mysql> select format(3.1415926, 2);
  +----------------------+
  | format(3.1415926, 2) |
  +----------------------+
  | 3.14                 |
  +----------------------+
  1 row in set (0.00 sec)
  ```

- 产生随机数

  ```sql
  mysql> select rand();
  +--------------------+
  | rand()             |
  +--------------------+
  | 0.4982955777070444 |
  +--------------------+
  1 row in set (0.01 sec)
  ```

## 四、其他函数

- `user()` 查询当前用户

  ```sql
  mysql> select user();
  +-----------------+
  | user()          |
  +-----------------+
  | ahwei@localhost |
  +-----------------+
  1 row in set (0.00 sec)
  ```

  其实，用户信息在`mysql`中也是用表结构来维护的：

  ```sql
  mysql> use mysql;
  Reading table information for completion of table and column names
  You can turn off this feature to get a quicker startup with -A
  
  Database changed
  mysql> show tables;
  +------------------------------------------------------+
  | Tables_in_mysql                                      |
  +------------------------------------------------------+
  | columns_priv                                         |
  | component                                            |
  | db                                                   |
  | default_roles                                        |
  | engine_cost                                          |
  | func                                                 |
  | general_log                                          |
  | global_grants                                        |
  | gtid_executed                                        |
  | help_category                                        |
  | help_keyword                                         |
  | help_relation                                        |
  | help_topic                                           |
  | innodb_index_stats                                   |
  | innodb_table_stats                                   |
  | ndb_binlog_index                                     |
  | password_history                                     |
  | plugin                                               |
  | procs_priv                                           |
  | proxies_priv                                         |
  | replication_asynchronous_connection_failover         |
  | replication_asynchronous_connection_failover_managed |
  | replication_group_configuration_version              |
  | replication_group_member_actions                     |
  | role_edges                                           |
  | server_cost                                          |
  | servers                                              |
  | slave_master_info                                    |
  | slave_relay_log_info                                 |
  | slave_worker_info                                    |
  | slow_log                                             |
  | tables_priv                                          |
  | time_zone                                            |
  | time_zone_leap_second                                |
  | time_zone_name                                       |
  | time_zone_transition                                 |
  | time_zone_transition_type                            |
  | user                                                 |
  +------------------------------------------------------+
  38 rows in set (0.00 sec)
  
  mysql> select * from user\G
  *************************** 1. row ***************************
                      Host: localhost
                      User: ahwei
               Select_priv: Y
               Insert_priv: Y
               Update_priv: Y
               Delete_priv: Y
               Create_priv: Y
                 Drop_priv: Y
               Reload_priv: Y
             Shutdown_priv: Y
              Process_priv: Y
                 File_priv: Y
                Grant_priv: N
           References_priv: Y
                Index_priv: Y
                Alter_priv: Y
              Show_db_priv: Y
                Super_priv: Y
     Create_tmp_table_priv: Y
          Lock_tables_priv: Y
              Execute_priv: Y
           Repl_slave_priv: Y
          Repl_client_priv: Y
          Create_view_priv: Y
            Show_view_priv: Y
       Create_routine_priv: Y
        Alter_routine_priv: Y
          Create_user_priv: Y
                Event_priv: Y
              Trigger_priv: Y
    Create_tablespace_priv: Y
                  ssl_type: 
                ssl_cipher: 0x
               x509_issuer: 0x
              x509_subject: 0x
             max_questions: 0
               max_updates: 0
           max_connections: 0
      max_user_connections: 0
                    plugin: caching_sha2_password
     authentication_string: $A$005$U?V=Qt/'@k
                                             FDzj(lLdlYMaKeHRGW0Vd.0lrFrUUl21iKoyi/3uSI6wxb5A
          password_expired: N
     password_last_changed: 2023-04-18 11:01:59
         password_lifetime: NULL
            account_locked: N
          Create_role_priv: Y
            Drop_role_priv: Y
    Password_reuse_history: NULL
       Password_reuse_time: NULL
  Password_require_current: NULL
           User_attributes: NULL
  *************************** 2. row ***************************
                      Host: localhost
                      User: mysql.infoschema
               Select_priv: Y
               Insert_priv: N
               Update_priv: N
               Delete_priv: N
               Create_priv: N
                 Drop_priv: N
               Reload_priv: N
             Shutdown_priv: N
              Process_priv: N
                 File_priv: N
                Grant_priv: N
           References_priv: N
                Index_priv: N
                Alter_priv: N
              Show_db_priv: N
                Super_priv: N
     Create_tmp_table_priv: N
          Lock_tables_priv: N
              Execute_priv: N
           Repl_slave_priv: N
          Repl_client_priv: N
          Create_view_priv: N
            Show_view_priv: N
       Create_routine_priv: N
        Alter_routine_priv: N
          Create_user_priv: N
                Event_priv: N
              Trigger_priv: N
    Create_tablespace_priv: N
                  ssl_type: 
                ssl_cipher: 0x
               x509_issuer: 0x
              x509_subject: 0x
             max_questions: 0
               max_updates: 0
           max_connections: 0
      max_user_connections: 0
                    plugin: caching_sha2_password
     authentication_string: $A$005$THISISACOMBINATIONOFINVALIDSALTANDPASSWORDTHATMUSTNEVERBRBEUSED
          password_expired: N
     password_last_changed: 2023-04-15 21:52:12
         password_lifetime: NULL
            account_locked: Y
          Create_role_priv: N
            Drop_role_priv: N
    Password_reuse_history: NULL
       Password_reuse_time: NULL
  Password_require_current: NULL
           User_attributes: NULL
  *************************** 3. row ***************************
                      Host: localhost
                      User: mysql.session
               Select_priv: N
               Insert_priv: N
               Update_priv: N
               Delete_priv: N
               Create_priv: N
                 Drop_priv: N
               Reload_priv: N
             Shutdown_priv: Y
              Process_priv: N
                 File_priv: N
                Grant_priv: N
           References_priv: N
                Index_priv: N
                Alter_priv: N
              Show_db_priv: N
                Super_priv: Y
     Create_tmp_table_priv: N
          Lock_tables_priv: N
              Execute_priv: N
           Repl_slave_priv: N
          Repl_client_priv: N
          Create_view_priv: N
            Show_view_priv: N
       Create_routine_priv: N
        Alter_routine_priv: N
          Create_user_priv: N
                Event_priv: N
              Trigger_priv: N
    Create_tablespace_priv: N
                  ssl_type: 
                ssl_cipher: 0x
               x509_issuer: 0x
              x509_subject: 0x
             max_questions: 0
               max_updates: 0
           max_connections: 0
      max_user_connections: 0
                    plugin: mysql_native_password
     authentication_string: *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE
          password_expired: N
     password_last_changed: 2023-04-07 08:54:38
         password_lifetime: NULL
            account_locked: Y
          Create_role_priv: N
            Drop_role_priv: N
    Password_reuse_history: NULL
       Password_reuse_time: NULL
  Password_require_current: NULL
           User_attributes: NULL
  *************************** 4. row ***************************
                      Host: localhost
                      User: mysql.sys
               Select_priv: N
               Insert_priv: N
               Update_priv: N
               Delete_priv: N
               Create_priv: N
                 Drop_priv: N
               Reload_priv: N
             Shutdown_priv: N
              Process_priv: N
                 File_priv: N
                Grant_priv: N
           References_priv: N
                Index_priv: N
                Alter_priv: N
              Show_db_priv: N
                Super_priv: N
     Create_tmp_table_priv: N
          Lock_tables_priv: N
              Execute_priv: N
           Repl_slave_priv: N
          Repl_client_priv: N
          Create_view_priv: N
            Show_view_priv: N
       Create_routine_priv: N
        Alter_routine_priv: N
          Create_user_priv: N
                Event_priv: N
              Trigger_priv: N
    Create_tablespace_priv: N
                  ssl_type: 
                ssl_cipher: 0x
               x509_issuer: 0x
              x509_subject: 0x
             max_questions: 0
               max_updates: 0
           max_connections: 0
      max_user_connections: 0
                    plugin: mysql_native_password
     authentication_string: *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE
          password_expired: N
     password_last_changed: 2023-04-07 08:54:38
         password_lifetime: NULL
            account_locked: Y
          Create_role_priv: N
            Drop_role_priv: N
    Password_reuse_history: NULL
       Password_reuse_time: NULL
  Password_require_current: NULL
           User_attributes: NULL
  *************************** 5. row ***************************
                      Host: localhost
                      User: root
               Select_priv: Y
               Insert_priv: Y
               Update_priv: Y
               Delete_priv: Y
               Create_priv: Y
                 Drop_priv: Y
               Reload_priv: Y
             Shutdown_priv: Y
              Process_priv: Y
                 File_priv: Y
                Grant_priv: Y
           References_priv: Y
                Index_priv: Y
                Alter_priv: Y
              Show_db_priv: Y
                Super_priv: Y
     Create_tmp_table_priv: Y
          Lock_tables_priv: Y
              Execute_priv: Y
           Repl_slave_priv: Y
          Repl_client_priv: Y
          Create_view_priv: Y
            Show_view_priv: Y
       Create_routine_priv: Y
        Alter_routine_priv: Y
          Create_user_priv: Y
                Event_priv: Y
              Trigger_priv: Y
    Create_tablespace_priv: Y
                  ssl_type: 
                ssl_cipher: 0x
               x509_issuer: 0x
              x509_subject: 0x
             max_questions: 0
               max_updates: 0
           max_connections: 0
      max_user_connections: 0
                    plugin: mysql_native_password
     authentication_string: *3A7A71F890413C0B661F424FD6728AFFCAA56D57
          password_expired: N
     password_last_changed: 2023-04-16 15:50:54
         password_lifetime: NULL
            account_locked: N
          Create_role_priv: Y
            Drop_role_priv: Y
    Password_reuse_history: NULL
       Password_reuse_time: NULL
  Password_require_current: NULL
           User_attributes: NULL
  5 rows in set (0.00 sec)
  ```

  未来对用户的管理操作，本质就是对这张`user`表做增删查改。

- `md5(str)`对一个字符串进行`md5`摘要，摘要后得到一个32位字符串

  ```sql
  mysql> select md5('admin');
  +----------------------------------+
  | md5('admin')                     |
  +----------------------------------+
  | 21232f297a57a5a743894a0e4a801fc3 |
  +----------------------------------+
  1 row in set (0.00 sec)
  ```

  ```sql
  mysql> select user, host, authentication_string from user;
  +------------------+-----------+------------------------------------------------------------------------+
  | user             | host      | authentication_string -- 数据摘要                                       |
  +------------------+-----------+------------------------------------------------------------------------+
  | ahwei            | localhost | $A$005$U?V=Qt/'@k
                                                    FDzj(lLdlYMaKeHRGW0Vd.0lrFrUUl21iKoyi/3uSI6wxb5A |
  | mysql.infoschema | localhost | $A$005$THISISACOMBINATIONOFINVALIDSALTANDPASSWORDTHATMUSTNEVERBRBEUSED |
  | mysql.session    | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE                              |
  | mysql.sys        | localhost | *THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE                              |
  | root             | localhost | *3A7A71F890413C0B661F424FD6728AFFCAA56D57                              |
  +------------------+-----------+------------------------------------------------------------------------+
  5 rows in set (0.00 sec)
  ```

  数据库不要明文存密码——不安全！

  ```sql
  mysql> create table if not exists user(
      -> name varchar(20) not null,
      -> password char(64) not null,
      -> reg_time datetime not null,
      -> id bigint unsigned primary key auto_increment
      -> );
  Query OK, 0 rows affected (0.06 sec)
  ```

  用`md5`对密码进行摘要：

  ```sql
  mysql> insert into user(name, password, reg_time) values ('阿伟', md5('666666'), now());
  Query OK, 1 row affected (0.02 sec)
  
  mysql> select * from user;
  +--------+----------------------------------+---------------------+----+
  | name   | password                         | reg_time            | id |
  +--------+----------------------------------+---------------------+----+
  | 阿伟   | f379eaf3c831b04de153469d1bec345e | 2023-04-30 16:57:14 |  1 |
  +--------+----------------------------------+---------------------+----+
  1 row in set (0.00 sec)
  ```

  而且通过上翻查不到有关密码的`sql`语句，因为这些语句会被`sql`过滤掉。

  用户的输入一定是明文，比较的时候两边都必须是摘要才能比较:

  ```SQL
  mysql> select * from user where password = '666666';
  Empty set (0.00 sec)
  
  mysql> select * from user where password = md5('666666');
  +--------+----------------------------------+---------------------+----+
  | name   | password                         | reg_time            | id |
  +--------+----------------------------------+---------------------+----+
  | 阿伟   | f379eaf3c831b04de153469d1bec345e | 2023-04-30 16:57:14 |  1 |
  +--------+----------------------------------+---------------------+----+
  1 row in set (0.00 sec)
  ```

  后端密码的比较本质是对摘要的比较。摘要不需要密钥，因为它无法逆向，所以它也可以被充当成一种加密。摘要并不需要解密，比对的时候只要知道他们两个相等就行了。

- `database()`显示当前正在使用的数据库

  ```sql
  mysql> select database();
  +------------+
  | database() |
  +------------+
  | scott      |
  +------------+
  1 row in set (0.00 sec)
  ```

- `password()`函数，`MySQL`数据库使用该函数对用户加密

  ```sql
  mysql> SELECT PASSWORD('mysql'), PASSWORD(NULL);
  +-------------------------------------------+----------------+
  | PASSWORD('mysql')                         | PASSWORD(NULL) |
  +-------------------------------------------+----------------+
  | *E74858DB86EBA20BC33D0AECAE8A8108C56B17FA |                |
  +-------------------------------------------+----------------+
  1 row in set, 1 warning (0.00 sec)
  ```

- `ifnull(val1， val2)` 如果`val1`为`null`，返回`val2`，否则返回`val1`的值

  ```sql
  mysql> select ifnull('abc', '123');
  +----------------------+
  | ifnull('abc', '123') |
  +----------------------+
  | abc                  |
  +----------------------+
  1 row in set (0.00 sec)
  ```

  ```sql
  mysql> select ifnull(null, '123');
  +---------------------+
  | ifnull(null, '123') |
  +---------------------+
  | 123                 |
  +---------------------+
  1 row in set (0.00 sec)
  ```

  ```sql
  mysql> select ifnull(NULL, NULL);
  +--------------------+
  | ifnull(NULL, NULL) |
  +--------------------+
  |               NULL |
  +--------------------+
  1 row in set (0.01 sec)
  ```

  