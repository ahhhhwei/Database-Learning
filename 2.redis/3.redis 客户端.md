# redis 客户端

## 一、Redis 通信协议

为什么可以实现一个 redis 的客户端，能否实现 QQ 客户端？

> 客户端和服务器在网络通信过程中，需要用到许多“协议”，传输层往下的协议，是在系统内核或驱动中实现的，只能选择，不能修改；而应用层，虽然业界也有很多成熟的协议（如HTTP），但更多的时候，都会自定义应用层协议，redis 这里就是自定义应用层协议。因此，要想开发一个 Redis 客户端，就要知道 Redis 的应用层协议。
>
> 而 QQ 没有公开它们自己使用的自定义协议，所以不能实现。网上一些开源项目实现了自定制的 qq 客户端，这是因为可以通过一些抓包/逆向手段，猜测 qq 应用层协议是啥样。

**Redis resp 协议**

redis 自己定制的一种「文本化二进制混合」协议格式，传输层基于 TCP，但是和 TCP 又没有强耦合，请求和响应之间的模型是一问一答的形式。优点是简单（人类也能看懂，`\r\n` 分行）、高效（长度前缀 + 二进制安全，传输二进制数据没问题）、易实现。

命令实际发送的时候是一个数组，每个命令参数是一个 `bulk string`：

```shell
*3\r\n
$3\r\n
SET\r\n
$5\r\n
mykey\r\n
$5\r\n
hello\r\n
```

含义拆开：

- `*3`：有 3 个元素（命令 + 2 个参数）
- `$3` `SET`：第一个元素，长度 3，内容 "SET"
- `$5` `mykey`：第二个元素，长度 5，内容 "mykey"
- `$5` `hello`：第三个元素，长度 5，内容 "hello"

Redis 返回一个简单字符串：

```shell
+OK\r\n
```

返回结果被写道 TCP socket 中

这套协议公开已久，已经有很多成熟的库实现了这套协议的解析/构造，我们此处使用 `redis-plus-plus`

## 二、安装 redis-plus-plus

### 1.安装 hiredis

redis-plus-plus 是基于 hiredis 实现的，hiredis 是一个 C 语言实现的 redis 客户端。

这里直接使用包管理器安装：

```bash
# ubuntu
apt install libhiredis-dev
# centos
yum install hiredis-devel.x86_64
```

### 2.安装 redis-plus-plus

安装 redis-plus-plus 只能通过源码编译的方式

> 使用 Ubuntu 会比 Centos 简单许多，因为 Ubuntu 上许多软件更新比较及时，版本比较高

- 下载源码

  ```shell
  git clone https://github.com/sewenew/redis-plus-plus.git
  ```

- Centos 

  Centos 自带的 cmake 版本比较低，需要先安装 cmake3

  ```shell
  yum install cmake3
  ```

  然后用 cmake3 构建项目：

  ```shell
  cd redis-plus-plus
  mkdir build
  cd build
  cmake3 ..
  make
  make install
  ```

- Ubuntu

  使用 cmake 构建：

  ```shell
  cd redis-plus-plus
  mkdir build
  cd build
  cmake ..
  make
  make install
  ```

  > make install：
  >
  > 此处是我们编译生成的内容，主要就是 .a 和 .so 文件，都是当前编译的这个目录下的，后续写代码不一定能找到这里的库，更推荐把这些库拷贝到系统目录中，make install 就是完成拷贝的工作

  构建成功后，会在 `/usr/local/include/` 中多出 `sw` 目录，并且内部包含 redis-plus-plus 的一系列头文件，在 `/usr/local/lib/` 中多出一系列 `libredis`  库文件

### 3.hello world

用 redis-plus-plus 连接 redis 服务器，再使用 ping 命令，检测一下连通性。

1. 包含头文件，因为库文件默认从 include 中搜索

   <img src="./pic/3-拷贝.png" style="zoom: 80%;" />

   所以这里要带上 `sw/redis++`，这里 sw 是作者名字缩写

   ![](./pic/3-包含头文件.png)

   > - #include<>：在系统目录中搜索头文件
   > - #include ""：在项目目录中搜索头文件

2. 创建一个 redis 对象

   ```c++
   // 创建 Redis对象的时候，需要在构造函数中指定 redis 服务器的地址和端口
   sw::redis::Redis redis("tcp://127.0.0.1:6379");
   ```

   > url 并非专属于 HTTP 的！

3. ping

   ```c++
   // 调用 ping 方法让客户端给服务器发一个 PING，然后服务器就会返回一个 PONG，就通过返回值获取到
   string res = redis.ping();
   // 打印 PONG
   cout << res << endl;
   ```

4. 使用 makefile 编译

   引入：

   - redis++ 自己的静态库

     ![](./pic/3-redis++静态库.png)

   - hiredis 的静态库

     ![](./pic/3-hiredis静态库.png)

   - 线程库